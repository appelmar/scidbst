<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">



<title>Year-wise linear regression on a TRMM data set</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Year-wise linear regression on a TRMM data set</h1>



<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(scidbst)
<span class="kw">library</span>(rgdal)
<span class="kw">library</span>(plyr)
<span class="kw">source</span>(<span class="st">&quot;/home/lahn/GitHub/scidbst/vignettes/assets/credentials.R&quot;</span>)
<span class="kw">scidbconnect</span>(<span class="dt">host=</span>host,<span class="dt">port=</span>port,<span class="dt">user=</span>user,<span class="dt">password=</span>password,<span class="dt">protocol=</span><span class="st">&quot;https&quot;</span>,<span class="dt">auth_type =</span> <span class="st">&quot;digest&quot;</span>)</code></pre></div>
<div id="aim-and-goals" class="section level1">
<h1>Aim and Goals</h1>
<p>In this Use Case, we are going to estimate model parameter for a linear regression using the 8 neighboring pixel for temporal chunks of one year. The main use of this will be to create a use case for a simple spatio-temporal analysis using r_exec on SciDB.</p>
<p>First we are going to create a smaller subset of the TRMM data set to develop a function that is able to perform the mentioned task above. Then we will run the analysis on a spatial subset, before we apply the analysis to the whole dataset.</p>
</div>
<div id="assumptions" class="section level1">
<h1>Assumptions</h1>
<p>We will use a worldwide TRMM data set from 01.01.1998 to 01.01.2015.</p>
<p>The data is reparted under the following conditions:</p>
<ul>
<li>the overlap in space is 1 pixel</li>
<li>the overlap in time is (number of years/4)+(1 or 2) -&gt; (15/4)+2 = ca. 6 days</li>
<li>the time dimension is chunked into 365 days</li>
<li>the dimensions are added as attributes with a prefixed “dim”, e.g. “dimx”,“dimy” and “dimt”</li>
</ul>
<p>This structure allows us to guarantee that combined with the overlap the data will accomodate the leap years and it will contain one year of data per chunk.</p>
</div>
<div id="rscript-operation" class="section level1">
<h1>RScript operation</h1>
<p>Now I will state a first version of the function that will be applied to the data chunk using the previous lines of code. The procedures are the following:</p>
<ol style="list-style-type: decimal">
<li>resolve the dot parameter and make the reference variables available in the function</li>
<li>find the data with a one year time span based on the minimum boundary of the whole array</li>
<li>add the neighboring cells to the original observed data in preparation for adapting the linear regression model
<ol style="list-style-type: lower-alpha">
<li>use a focal operation to create RasterLayers with the neighboring cells for each pixel</li>
<li>retransform the layer stacks into a data.frame</li>
</ol></li>
<li>calculate the linear models per pixel and store relevant information in a data.frame for output</li>
</ol>
<p>Funcion details: x is the data.frame of the chunk and with … we will pass the spatial and temporal reference parameter.</p>
<div id="resolve-dot-parameter" class="section level2">
<h2>Resolve dot parameter</h2>
<p>Using ‘lapply’ we establish the named variables in the functions environment (‘linearRegressionNeighborhood’) from the additional parameters. Those parameters are the spatio-temporal references of the scidbst object.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dot.input =<span class="st"> </span><span class="kw">list</span>(...)

i &lt;-<span class="st"> </span><span class="dv">1</span>
<span class="kw">lapply</span>(dot.input, function(x,y) {
    <span class="kw">assign</span>(<span class="dt">x=</span>y[i],<span class="dt">value=</span>x,<span class="dt">envir=</span><span class="kw">parent.env</span>(<span class="kw">environment</span>()))
    i &lt;&lt;-<span class="st"> </span>i<span class="dv">+1</span>
    x},
    <span class="kw">names</span>(dot.input))
<span class="kw">rm</span>(i)</code></pre></div>
</div>
<div id="restrict-data-to-one-exactly-one-year" class="section level2">
<h2>Restrict data to one exactly one year</h2>
<p>Due to the overlap of the chunks and the leap year problem we cannot use equal 365 days years. So we need to find the first and last day of the year indices. To achieve that we assign a helper function that makes use of the sequence function for POSIXt timestamps ( <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/seq.POSIXt.html">seq.POSIXt</a>). For the output later on we will calculate the number of the year, since the output will be a yearwise aggregation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> <span class="co"># helper function to add a certain time to a date</span>
addTime =<span class="st"> </span>function(x, i, what) {
    byText =<span class="st"> </span><span class="kw">paste</span>(i,what)
    <span class="kw">seq</span>(x,<span class="dt">by=</span>byText,<span class="dt">length=</span><span class="dv">2</span>)[<span class="dv">2</span>]
}

<span class="co"># determine the first and last index of the yearly subset in the chunk</span>
first =<span class="st"> </span><span class="dv">0</span>
last =<span class="st"> </span><span class="dv">0</span>

while (!<span class="st"> </span><span class="kw">any</span>(first %in%<span class="st"> </span>x$dimt) ) {
    indexDate =<span class="st"> </span><span class="kw">addTime</span>(t0,first,tunit) <span class="co"># current date of first</span>
    first &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">difftime</span>(<span class="kw">addTime</span>(indexDate,<span class="dv">1</span>,<span class="st">&quot;year&quot;</span>),t0)) <span class="co"># 1 year later of indexDate</span>
    last &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">difftime</span>(<span class="kw">addTime</span>(<span class="kw">addTime</span>(indexDate,<span class="dv">2</span>,<span class="st">&quot;year&quot;</span>),-<span class="dv">1</span>,<span class="st">&quot;day&quot;</span>),t0)) <span class="co"># 2 years later - 1 day from indexDate</span>
}

numberOfYear =<span class="st"> </span><span class="kw">as.POSIXlt</span>(<span class="kw">addTime</span>(t0,first,tunit))$year -<span class="st"> </span><span class="kw">as.POSIXlt</span>(t0)$year</code></pre></div>
</div>
<div id="prepare-the-data-for-calculation" class="section level2">
<h2>Prepare the data for calculation</h2>
<p>At first we will create a data structure that contains the neighboring cells in addition to each original value. Since this is a raster im age operation we will create a daily spatial raster layer timeline in each chunk. Therefore we use a focal matrix operation on the raster to select the correct neighboring cells for each cell and stack them.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">addNeighboringValues =<span class="st"> </span>function(x) {
    t =<span class="st"> </span><span class="kw">unique</span>(x$dimt)
    x=<span class="st"> </span>x[,-<span class="kw">which</span>(<span class="st">&quot;dimt&quot;</span> ==<span class="st"> </span><span class="kw">names</span>(x))]
    <span class="kw">coordinates</span>(x) =<span class="st"> </span><span class="er">~</span>dimx+dimy
    <span class="kw">gridded</span>(x) =<span class="st"> </span><span class="ot">TRUE</span>
    layer =<span class="st"> </span><span class="kw">as</span>(x,<span class="st">&quot;RasterLayer&quot;</span>)
  
    p1 =<span class="st"> </span><span class="kw">focal</span>(layer, <span class="dt">w=</span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>),<span class="dt">nr =</span> <span class="dv">3</span>, <span class="dt">nc=</span><span class="dv">3</span>,<span class="dt">byrow=</span><span class="ot">TRUE</span>))
    p2 =<span class="st"> </span><span class="kw">focal</span>(layer, <span class="dt">w=</span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>),<span class="dt">nr =</span> <span class="dv">3</span>, <span class="dt">nc=</span><span class="dv">3</span>,<span class="dt">byrow=</span><span class="ot">TRUE</span>))
    p3 =<span class="st"> </span><span class="kw">focal</span>(layer, <span class="dt">w=</span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>),<span class="dt">nr =</span> <span class="dv">3</span>, <span class="dt">nc=</span><span class="dv">3</span>,<span class="dt">byrow=</span><span class="ot">TRUE</span>))
    p4 =<span class="st"> </span><span class="kw">focal</span>(layer, <span class="dt">w=</span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>),<span class="dt">nr =</span> <span class="dv">3</span>, <span class="dt">nc=</span><span class="dv">3</span>,<span class="dt">byrow=</span><span class="ot">TRUE</span>))
    
    p6 =<span class="st"> </span><span class="kw">focal</span>(layer, <span class="dt">w=</span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>),<span class="dt">nr =</span> <span class="dv">3</span>, <span class="dt">nc=</span><span class="dv">3</span>,<span class="dt">byrow=</span><span class="ot">TRUE</span>))
    p7 =<span class="st"> </span><span class="kw">focal</span>(layer, <span class="dt">w=</span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>),<span class="dt">nr =</span> <span class="dv">3</span>, <span class="dt">nc=</span><span class="dv">3</span>,<span class="dt">byrow=</span><span class="ot">TRUE</span>))
    p8 =<span class="st"> </span><span class="kw">focal</span>(layer, <span class="dt">w=</span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>),<span class="dt">nr =</span> <span class="dv">3</span>, <span class="dt">nc=</span><span class="dv">3</span>,<span class="dt">byrow=</span><span class="ot">TRUE</span>))
    p9 =<span class="st"> </span><span class="kw">focal</span>(layer, <span class="dt">w=</span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>),<span class="dt">nr =</span> <span class="dv">3</span>, <span class="dt">nc=</span><span class="dv">3</span>,<span class="dt">byrow=</span><span class="ot">TRUE</span>))
    
    stack =<span class="st"> </span><span class="kw">stack</span>(<span class="kw">list</span>(<span class="dt">orig.values=</span>layer,<span class="dt">p1=</span>p1,<span class="dt">p2=</span>p2,<span class="dt">p3=</span>p3,<span class="dt">p4=</span>p4,<span class="dt">p6=</span>p6,<span class="dt">p7=</span>p7,<span class="dt">p8=</span>p8,<span class="dt">p9=</span>p9))
    <span class="kw">list</span>(<span class="dt">t=</span>t,<span class="dt">data=</span>stack)
}
layer.timeline =<span class="st"> </span><span class="kw">dlply</span>(x, <span class="dt">.variables=</span><span class="kw">c</span>(<span class="st">&quot;dimt&quot;</span>), <span class="dt">.fun =</span> addNeighboringValues)</code></pre></div>
<p>The output of the operation is a list of lists containing the time index ‘t’ and the layer stack ‘data’. To perform the linear regression algorithm we need to restructure the data as a data.frame. As a precaution we remove the any NA values that might interfere with a successful calculation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rebuildDataFrame =<span class="st"> </span>function(x) {
    b =<span class="st"> </span><span class="kw">cbind</span>(<span class="dt">dimy=</span><span class="kw">coordinates</span>(x$data)[,<span class="st">&quot;y&quot;</span>],<span class="dt">dimx=</span><span class="kw">coordinates</span>(x$data)[,<span class="st">&quot;x&quot;</span>],<span class="dt">dimt=</span>x$t,<span class="kw">getValues</span>(x$data))
    <span class="kw">as.data.frame</span>(b)
}
neighbor.df =<span class="st"> </span><span class="kw">ldply</span>(layer.timeline[], <span class="dt">.fun =</span> rebuildDataFrame)
neighbor.df =<span class="st"> </span><span class="kw">na.omit</span>(neighbor.df)</code></pre></div>
</div>
<div id="running-the-linear-regression-and-prepare-output" class="section level2">
<h2>Running the linear regression and prepare output</h2>
<p>Using again a plyr function we sort the data.frame ascending in time and adapt a linear regression model, based on the the neighboring cell values. For the output we will create a data.frame containing the coordinates, model parameter and some statistical quality values.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">lmCalculation =<span class="st"> </span>function(x,year) {
    <span class="co">#sort by t ascending by time</span>
    x =<span class="st"> </span><span class="kw">arrange</span>(x,dimt)
  
    model =<span class="st"> </span><span class="kw">lm</span>(orig.values~p1+p2+p3+p4+p6+p7+p8+p9, x,<span class="dt">na.action=</span>na.omit)
    c =<span class="st"> </span><span class="kw">coefficients</span>(model)
    s =<span class="st"> </span><span class="kw">summary</span>(model)
    <span class="kw">data.frame</span>(<span class="dt">dimy=</span><span class="kw">unique</span>(x$dimy),
               <span class="dt">dimx=</span><span class="kw">unique</span>(x$dimx),
               <span class="dt">dimt=</span><span class="kw">as</span>(year*<span class="fl">1.0</span>,<span class="st">&quot;double&quot;</span>),
               <span class="dt">intercept =</span> c[<span class="dv">1</span>],
               <span class="dt">c_p1=</span> c[<span class="dv">2</span>],
               <span class="dt">c_p2=</span> c[<span class="dv">3</span>],
               <span class="dt">c_p3=</span> c[<span class="dv">4</span>],
               <span class="dt">c_p4=</span> c[<span class="dv">5</span>],
               <span class="dt">c_p6=</span> c[<span class="dv">6</span>],
               <span class="dt">c_p7=</span> c[<span class="dv">7</span>],
               <span class="dt">c_p8=</span> c[<span class="dv">8</span>],
               <span class="dt">c_p9=</span> c[<span class="dv">9</span>],
               <span class="dt">r_sq =</span> s$r.squared,
               <span class="dt">sum_res_sq =</span> <span class="kw">sum</span>(s$residuals^<span class="dv">2</span>))
}
calculated.df =<span class="st"> </span><span class="kw">ddply</span>(neighbor.df, <span class="dt">.variables=</span><span class="kw">c</span>(<span class="st">&quot;dimy&quot;</span>,<span class="st">&quot;dimx&quot;</span>), <span class="dt">.fun =</span> lmCalculation, <span class="dt">year=</span>numberOfYear)
calculated.df =<span class="st"> </span><span class="kw">na.omit</span>(calculated.df)</code></pre></div>
<p>Lastly, the complete function that will be integrated into the R-Script:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">linearRegressionNeighborhood =<span class="st"> </span>function(x, ...) {
    <span class="co">#make the dots named parameters available in this function</span>
    dot.input =<span class="st"> </span><span class="kw">list</span>(...)
    
    i &lt;-<span class="st"> </span><span class="dv">1</span>
    <span class="kw">lapply</span>(dot.input, function(x,y) {
        <span class="kw">assign</span>(<span class="dt">x=</span>y[i],<span class="dt">value=</span>x,<span class="dt">envir=</span><span class="kw">parent.env</span>(<span class="kw">environment</span>()))
        i &lt;&lt;-<span class="st"> </span>i<span class="dv">+1</span>
        x},
        <span class="kw">names</span>(dot.input))
    <span class="kw">rm</span>(i)
  
    <span class="kw">cat</span>(<span class="st">&quot;processing chunk&quot;</span>,<span class="dt">file=</span><span class="st">&quot;/tmp/r_exec/lahn/trmm_linear.log&quot;</span>,<span class="dt">append=</span><span class="ot">TRUE</span>,<span class="dt">sep=</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)
    additionalParams =<span class="st"> </span><span class="kw">names</span>(<span class="kw">list</span>(...))
    <span class="kw">cat</span>(<span class="kw">paste</span>(<span class="st">&quot;Using additional parameter through ...:&quot;</span>),<span class="dt">file=</span><span class="st">&quot;/tmp/r_exec/lahn/trmm_linear.log&quot;</span>,<span class="dt">append=</span><span class="ot">TRUE</span>,<span class="dt">sep=</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)
    <span class="kw">cat</span>(<span class="kw">paste</span>(additionalParams,<span class="dt">collapse=</span><span class="st">&quot;, &quot;</span>),<span class="dt">file=</span><span class="st">&quot;/tmp/r_exec/lahn/trmm_linear.log&quot;</span>,<span class="dt">append=</span><span class="ot">TRUE</span>,<span class="dt">sep=</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)
    
    <span class="co"># helper function to add a certain time to a date</span>
    addTime =<span class="st"> </span>function(x, i, what) {
        byText =<span class="st"> </span><span class="kw">paste</span>(i,what)
        <span class="kw">seq</span>(x,<span class="dt">by=</span>byText,<span class="dt">length=</span><span class="dv">2</span>)[<span class="dv">2</span>]
    }
  
    <span class="co"># determine the first and last index of the yearly subset in the chunk</span>
    first =<span class="st"> </span><span class="dv">0</span>
    last =<span class="st"> </span><span class="dv">0</span>
    
    while (!<span class="st"> </span><span class="kw">any</span>(first %in%<span class="st"> </span>x$dimt) ) {
        indexDate =<span class="st"> </span><span class="kw">addTime</span>(t0,first,tunit) <span class="co"># current date of first</span>
        first &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">difftime</span>(<span class="kw">addTime</span>(indexDate,<span class="dv">1</span>,<span class="st">&quot;year&quot;</span>),t0)) <span class="co"># 1 year later of indexDate</span>
        last &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">difftime</span>(<span class="kw">addTime</span>(<span class="kw">addTime</span>(indexDate,<span class="dv">2</span>,<span class="st">&quot;year&quot;</span>),-<span class="dv">1</span>,<span class="st">&quot;day&quot;</span>),t0)) <span class="co"># 2 years later - 1 day from indexDate</span>
    }
    
    numberOfYear =<span class="st"> </span><span class="kw">as.POSIXlt</span>(<span class="kw">addTime</span>(t0,first,tunit))$year -<span class="st"> </span><span class="kw">as.POSIXlt</span>(t0)$year

    
    <span class="co"># create a subset to use only data from one year</span>
    
    x =<span class="st"> </span><span class="kw">na.omit</span>(x[<span class="kw">which</span>(x$dimt %in%<span class="st"> </span>first:last),])
    
    <span class="co"># add the neighboring values to each of the pixel values using raster operations</span>
    addNeighboringValues =<span class="st"> </span>function(x) {
        t =<span class="st"> </span><span class="kw">unique</span>(x$dimt)
        x=<span class="st"> </span>x[,-<span class="kw">which</span>(<span class="st">&quot;dimt&quot;</span> ==<span class="st"> </span><span class="kw">names</span>(x))]
        <span class="kw">coordinates</span>(x) =<span class="st"> </span><span class="er">~</span>dimx+dimy
        <span class="kw">gridded</span>(x) =<span class="st"> </span><span class="ot">TRUE</span>
        layer =<span class="st"> </span><span class="kw">as</span>(x,<span class="st">&quot;RasterLayer&quot;</span>)
      
        p1 =<span class="st"> </span><span class="kw">focal</span>(layer, <span class="dt">w=</span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>),<span class="dt">nr =</span> <span class="dv">3</span>, <span class="dt">nc=</span><span class="dv">3</span>,<span class="dt">byrow=</span><span class="ot">TRUE</span>))
        p2 =<span class="st"> </span><span class="kw">focal</span>(layer, <span class="dt">w=</span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>),<span class="dt">nr =</span> <span class="dv">3</span>, <span class="dt">nc=</span><span class="dv">3</span>,<span class="dt">byrow=</span><span class="ot">TRUE</span>))
        p3 =<span class="st"> </span><span class="kw">focal</span>(layer, <span class="dt">w=</span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>),<span class="dt">nr =</span> <span class="dv">3</span>, <span class="dt">nc=</span><span class="dv">3</span>,<span class="dt">byrow=</span><span class="ot">TRUE</span>))
        p4 =<span class="st"> </span><span class="kw">focal</span>(layer, <span class="dt">w=</span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>),<span class="dt">nr =</span> <span class="dv">3</span>, <span class="dt">nc=</span><span class="dv">3</span>,<span class="dt">byrow=</span><span class="ot">TRUE</span>))
        
        p6 =<span class="st"> </span><span class="kw">focal</span>(layer, <span class="dt">w=</span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>),<span class="dt">nr =</span> <span class="dv">3</span>, <span class="dt">nc=</span><span class="dv">3</span>,<span class="dt">byrow=</span><span class="ot">TRUE</span>))
        p7 =<span class="st"> </span><span class="kw">focal</span>(layer, <span class="dt">w=</span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>),<span class="dt">nr =</span> <span class="dv">3</span>, <span class="dt">nc=</span><span class="dv">3</span>,<span class="dt">byrow=</span><span class="ot">TRUE</span>))
        p8 =<span class="st"> </span><span class="kw">focal</span>(layer, <span class="dt">w=</span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>),<span class="dt">nr =</span> <span class="dv">3</span>, <span class="dt">nc=</span><span class="dv">3</span>,<span class="dt">byrow=</span><span class="ot">TRUE</span>))
        p9 =<span class="st"> </span><span class="kw">focal</span>(layer, <span class="dt">w=</span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>),<span class="dt">nr =</span> <span class="dv">3</span>, <span class="dt">nc=</span><span class="dv">3</span>,<span class="dt">byrow=</span><span class="ot">TRUE</span>))
        
        stack =<span class="st"> </span><span class="kw">stack</span>(<span class="kw">list</span>(<span class="dt">orig.values=</span>layer,<span class="dt">p1=</span>p1,<span class="dt">p2=</span>p2,<span class="dt">p3=</span>p3,<span class="dt">p4=</span>p4,<span class="dt">p6=</span>p6,<span class="dt">p7=</span>p7,<span class="dt">p8=</span>p8,<span class="dt">p9=</span>p9))
        <span class="kw">list</span>(<span class="dt">t=</span>t,<span class="dt">data=</span>stack)
    }
    layer.timeline =<span class="st"> </span><span class="kw">dlply</span>(x, <span class="dt">.variables=</span><span class="kw">c</span>(<span class="st">&quot;dimt&quot;</span>), <span class="dt">.fun =</span> addNeighboringValues)
    
    <span class="co"># create a data.frame from the RasterStacks and omit the NA values in the overlap border</span>
    <span class="co"># careful x and y are the assigned names for coordinates in package raster</span>
    rebuildDataFrame =<span class="st"> </span>function(x) {
        b =<span class="st"> </span><span class="kw">cbind</span>(<span class="dt">dimy=</span><span class="kw">coordinates</span>(x$data)[,<span class="st">&quot;y&quot;</span>],<span class="dt">dimx=</span><span class="kw">coordinates</span>(x$data)[,<span class="st">&quot;x&quot;</span>],<span class="dt">dimt=</span>x$t,<span class="kw">getValues</span>(x$data))
        <span class="kw">as.data.frame</span>(b)
    }
    neighbor.df =<span class="st"> </span><span class="kw">ldply</span>(layer.timeline[], <span class="dt">.fun =</span> rebuildDataFrame)
    neighbor.df =<span class="st"> </span><span class="kw">na.omit</span>(neighbor.df)
    
    <span class="co"># fit linear regression models on each pixel, using year as parameter</span>
    lmCalculation =<span class="st"> </span>function(x,year) {
        <span class="co">#sort by t ascending by time</span>
        x =<span class="st"> </span><span class="kw">arrange</span>(x,dimt)
      
        model =<span class="st"> </span><span class="kw">lm</span>(orig.values~p1+p2+p3+p4+p6+p7+p8+p9, x,<span class="dt">na.action=</span>na.omit)
        c =<span class="st"> </span><span class="kw">coefficients</span>(model)
        s =<span class="st"> </span><span class="kw">summary</span>(model)
        <span class="kw">data.frame</span>(<span class="dt">dimy=</span><span class="kw">unique</span>(x$dimy),
                   <span class="dt">dimx=</span><span class="kw">unique</span>(x$dimx),
                   <span class="dt">dimt=</span><span class="kw">as</span>(year*<span class="fl">1.0</span>,<span class="st">&quot;double&quot;</span>),
                   <span class="dt">intercept =</span> c[<span class="dv">1</span>],
                   <span class="dt">c_p1=</span> c[<span class="dv">2</span>],
                   <span class="dt">c_p2=</span> c[<span class="dv">3</span>],
                   <span class="dt">c_p3=</span> c[<span class="dv">4</span>],
                   <span class="dt">c_p4=</span> c[<span class="dv">5</span>],
                   <span class="dt">c_p6=</span> c[<span class="dv">6</span>],
                   <span class="dt">c_p7=</span> c[<span class="dv">7</span>],
                   <span class="dt">c_p8=</span> c[<span class="dv">8</span>],
                   <span class="dt">c_p9=</span> c[<span class="dv">9</span>],
                   <span class="dt">r_sq =</span> s$r.squared,
                   <span class="dt">sum_res_sq =</span> <span class="kw">sum</span>(s$residuals^<span class="dv">2</span>))
    }
    calculated.df =<span class="st"> </span><span class="kw">ddply</span>(neighbor.df, <span class="dt">.variables=</span><span class="kw">c</span>(<span class="st">&quot;dimy&quot;</span>,<span class="st">&quot;dimx&quot;</span>), <span class="dt">.fun =</span> lmCalculation, <span class="dt">year=</span>numberOfYear)
    
    calculated.df =<span class="st"> </span><span class="kw">na.omit</span>(calculated.df)
    <span class="kw">cat</span>(<span class="kw">paste</span>(<span class="st">&quot;Finished year:&quot;</span>,numberOfYear),<span class="dt">file=</span><span class="st">&quot;/tmp/r_exec/lahn/trmm_linear.log&quot;</span>,<span class="dt">append=</span><span class="ot">TRUE</span>,<span class="dt">sep=</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)
    <span class="kw">return</span>(calculated.df)
}</code></pre></div>
</div>
<div id="notes" class="section level2">
<h2>Notes</h2>
<p>Debugging the user defined R code will be somewhat hard, because r_exec in SciDB does not return detailed error information. Be advised to test your code locally on a small data chunk, before going “BIG”. Also avoid the following pitfalls:</p>
<ul>
<li>make sure that the resulting values are of type double: meaning remove all NA and multiply integer values with 1.0</li>
<li>when using the raster package remember that the labels for coordinates are “x” and “y”</li>
</ul>
</div>
</div>
<div id="test-the-script-on-a-spatial-subset" class="section level1">
<h1>Test the Script on a spatial subset</h1>
<p>Prepare a TRMM spatial subset to run the query.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">name =<span class="st"> &quot;trmm_ethiopia_sub_reparted&quot;</span>
arrays =<span class="st"> </span><span class="kw">scidbls</span>()

if (!<span class="st"> </span>name %in%<span class="st"> </span>arrays) {
  trmm =<span class="st"> </span><span class="kw">scidbst</span>(<span class="st">&quot;TRMM3B42_DAILY_PREC&quot;</span>)
  ex =<span class="st"> </span><span class="kw">extent</span>(<span class="dv">32</span>,<span class="dv">46</span>,<span class="dv">1</span>,<span class="dv">15</span>)
  trmm.sub =<span class="st"> </span><span class="kw">subarray</span>(trmm,ex,<span class="dt">between=</span><span class="ot">TRUE</span>)
  trmm.sub =<span class="st"> </span><span class="kw">scidbsteval</span>(trmm.sub,<span class="st">&quot;trmm_ethiopia_sub&quot;</span>)
  trmm.sub =<span class="st"> </span><span class="kw">transform</span>(trmm.sub,<span class="dt">dimy=</span><span class="st">&quot;double(y)&quot;</span>,<span class="dt">dimx=</span><span class="st">&quot;double(x)&quot;</span>,<span class="dt">dimt=</span><span class="st">&quot;double(t)&quot;</span>)
  trmm.reparted =<span class="st"> </span><span class="kw">repart</span>(trmm.sub,<span class="dt">schema=</span><span class="st">&quot;&lt;band1:double,dimy:double,dimx:double,dimt:double&gt; [y=0:399,30,1,x=0:1439,30,1,t=0:*,365,6]&quot;</span>)
  trmm.reparted =<span class="st"> </span><span class="kw">scidbsteval</span>(trmm.reparted,<span class="st">&quot;trmm_ethiopia_sub_reparted&quot;</span>)
} else {
  trmm.reparted =<span class="st"> </span><span class="kw">scidbst</span>(<span class="st">&quot;trmm_ethiopia_sub_reparted&quot;</span>)
}</code></pre></div>
<p>Perform a dry-run and show the script that was passed to as expression to r_exec.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">script &lt;-<span class="st"> </span><span class="kw">r.apply</span>(<span class="dt">x=</span>trmm.reparted,
                   <span class="dt">f =</span> linearRegressionNeighborhood,
                   <span class="dt">array =</span> <span class="st">&quot;trmm_yearly_linear_model&quot;</span>,
                   <span class="dt">packages =</span> <span class="kw">c</span>(<span class="st">&quot;raster&quot;</span>,<span class="st">&quot;sp&quot;</span>,<span class="st">&quot;rgdal&quot;</span>,<span class="st">&quot;plyr&quot;</span>),
                   <span class="dt">aggregates=</span><span class="kw">c</span>(),
                   <span class="dt">output =</span> <span class="kw">list</span>(<span class="dt">dimy=</span><span class="st">&quot;double&quot;</span>,
                                 <span class="dt">dimx=</span><span class="st">&quot;double&quot;</span>,
                                 <span class="dt">dimt=</span><span class="st">&quot;double&quot;</span>,
                                 <span class="dt">intercept=</span><span class="st">&quot;double&quot;</span>,
                                 <span class="dt">c_p1=</span> <span class="st">&quot;double&quot;</span>,
                                 <span class="dt">c_p2=</span> <span class="st">&quot;double&quot;</span>,
                                 <span class="dt">c_p3=</span> <span class="st">&quot;double&quot;</span>,
                                 <span class="dt">c_p4=</span> <span class="st">&quot;double&quot;</span>,
                                 <span class="dt">c_p6=</span> <span class="st">&quot;double&quot;</span>,
                                 <span class="dt">c_p7=</span> <span class="st">&quot;double&quot;</span>,
                                 <span class="dt">c_p8=</span> <span class="st">&quot;double&quot;</span>,
                                 <span class="dt">c_p9=</span> <span class="st">&quot;double&quot;</span>,
                                 <span class="dt">r_sq =</span> <span class="st">&quot;double&quot;</span>,
                                 <span class="dt">sum_res_sq =</span> <span class="st">&quot;double&quot;</span>),
                   <span class="dt">eval=</span><span class="ot">FALSE</span>,
                   <span class="dt">return=</span><span class="st">&quot;rscript&quot;</span>
                   )
<span class="kw">cat</span>(script)</code></pre></div>
<pre><code>store(unpack(r_exec(trmm_ethiopia_sub_reparted,'output_attrs=14','expr=if (! require(raster)) { install.packages(&quot;raster&quot;,repos=&quot;https://cloud.r-project.org/&quot;)
 library(raster)}
 if (! require(sp)) { install.packages(&quot;sp&quot;,repos=&quot;https://cloud.r-project.org/&quot;)
 library(sp)}
 if (! require(rgdal)) { install.packages(&quot;rgdal&quot;,repos=&quot;https://cloud.r-project.org/&quot;)
 library(rgdal)}
 if (! require(plyr)) { install.packages(&quot;plyr&quot;,repos=&quot;https://cloud.r-project.org/&quot;)
 library(plyr)}
 affine &lt;- matrix(c(-180.000000,50.000000,0.250000,0.000000,0.000000,-0.250000),nc=3,nr=2)
 crs &lt;- CRS(&quot;+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0&quot;)
 extent &lt;- extent(32.000000,46.250000,0.750000,15.000000)
 tmin &lt;- as.POSIXlt(&quot;1998-01-01&quot;)
 tmax &lt;- as.POSIXlt(&quot;2015-01-02&quot;)
 t0 &lt;- as.POSIXlt(&quot;1998-01-01&quot;)
 tunit &lt;- &quot;days&quot;
 tres &lt;- 1.000000
 df = data.frame(band1=band1,dimy=dimy,dimx=dimx,dimt=dimt)
 f &lt;- function(x, ...) {     #make the dots named parameters available in this function
     dot.input = list(...)
      i &lt;- 1
     lapply(dot.input, function(x,y) {         assign(x=y[i],value=x,envir=parent.env(environment()))
         i &lt;&lt;- i+1
         x},
         names(dot.input))
     rm(i)
      cat(&quot;processing chunk&quot;,file=&quot;/tmp/r_exec/lahn/trmm_linear.log&quot;,append=TRUE,sep=&quot;\n&quot;)
     additionalParams = names(list(...))
     cat(paste(&quot;Using additional parameter through ...:&quot;),file=&quot;/tmp/r_exec/lahn/trmm_linear.log&quot;,append=TRUE,sep=&quot;\n&quot;)
     cat(paste(additionalParams,collapse=&quot;, &quot;),file=&quot;/tmp/r_exec/lahn/trmm_linear.log&quot;,append=TRUE,sep=&quot;\n&quot;)
      # helper function to add a certain time to a date
     addTime = function(x, i, what) {         byText = paste(i,what)
         seq(x,by=byText,length=2)[2]
     }
      # determine the first and last index of the yearly subset in the chunk
     first = 0
     last = 0
      while (! any(first %in% x$dimt) ) {         indexDate = addTime(t0,first,tunit) # current date of first
         first &lt;- as.numeric(difftime(addTime(indexDate,1,&quot;year&quot;),t0)) # 1 year later of indexDate
         last &lt;- as.numeric(difftime(addTime(addTime(indexDate,2,&quot;year&quot;),-1,&quot;day&quot;),t0)) # 2 years later - 1 day from indexDate
     }
      numberOfYear = as.POSIXlt(addTime(t0,first,tunit))$year - as.POSIXlt(t0)$year
      
     # create a subset to use only data from one year
      x = na.omit(x[which(x$dimt %in% first:last),])
      # add the neighboring values to each of the pixel values using raster operations
     addNeighboringValues = function(x) {         t = unique(x$dimt)
         x= x[,-which(&quot;dimt&quot; == names(x))]
         coordinates(x) = ~dimx+dimy
         gridded(x) = TRUE
         layer = as(x,&quot;RasterLayer&quot;)
          p1 = focal(layer, w=matrix(c(1,0,0, 0, 0, 0, 0, 0, 0),nr = 3, nc=3,byrow=TRUE))
         p2 = focal(layer, w=matrix(c(0,1,0, 0, 0, 0, 0, 0, 0),nr = 3, nc=3,byrow=TRUE))
         p3 = focal(layer, w=matrix(c(0,0,1, 0, 0, 0, 0, 0, 0),nr = 3, nc=3,byrow=TRUE))
         p4 = focal(layer, w=matrix(c(0,0,0, 1, 0, 0, 0, 0, 0),nr = 3, nc=3,byrow=TRUE))
          p6 = focal(layer, w=matrix(c(0,0,0, 0, 0, 1, 0, 0, 0),nr = 3, nc=3,byrow=TRUE))
         p7 = focal(layer, w=matrix(c(0,0,0, 0, 0, 0, 1, 0, 0),nr = 3, nc=3,byrow=TRUE))
         p8 = focal(layer, w=matrix(c(0,0,0, 0, 0, 0, 0, 1, 0),nr = 3, nc=3,byrow=TRUE))
         p9 = focal(layer, w=matrix(c(0,0,0, 0, 0, 0, 0, 0, 1),nr = 3, nc=3,byrow=TRUE))
          stack = stack(list(orig.values=layer,p1=p1,p2=p2,p3=p3,p4=p4,p6=p6,p7=p7,p8=p8,p9=p9))
         list(t=t,data=stack)
     }
     layer.timeline = dlply(x, .variables=c(&quot;dimt&quot;), .fun = addNeighboringValues)
      # create a data.frame from the RasterStacks and omit the NA values in the overlap border
     # careful x and y are the assigned names for coordinates in package raster
     rebuildDataFrame = function(x) {         b = cbind(dimy=coordinates(x$data)[,&quot;y&quot;],dimx=coordinates(x$data)[,&quot;x&quot;],dimt=x$t,getValues(x$data))
         as.data.frame(b)
     }
     neighbor.df = ldply(layer.timeline[], .fun = rebuildDataFrame)
     neighbor.df = na.omit(neighbor.df)
      # fit linear regression models on each pixel, using year as parameter
     lmCalculation = function(x,year) {         #sort by t ascending by time
         x = arrange(x,dimt)
          model = lm(orig.values~p1+p2+p3+p4+p6+p7+p8+p9, x,na.action=na.omit)
         c = coefficients(model)
         s = summary(model)
         data.frame(dimy=unique(x$dimy),
                    dimx=unique(x$dimx),
                    dimt=as(year*1.0,&quot;double&quot;),
                    intercept = c[1],
                    c_p1= c[2],
                    c_p2= c[3],
                    c_p3= c[4],
                    c_p4= c[5],
                    c_p6= c[6],
                    c_p7= c[7],
                    c_p8= c[8],
                    c_p9= c[9],
                    r_sq = s$r.squared,
                    sum_res_sq = sum(s$residuals^2))
     }
     calculated.df = ddply(neighbor.df, .variables=c(&quot;dimy&quot;,&quot;dimx&quot;), .fun = lmCalculation, year=numberOfYear)
      calculated.df = na.omit(calculated.df)
     cat(paste(&quot;Finished year:&quot;,numberOfYear),file=&quot;/tmp/r_exec/lahn/trmm_linear.log&quot;,append=TRUE,sep=&quot;\n&quot;)
     return(calculated.df)
 }
 if (! require(foreach)) { install.packages(&quot;foreach&quot;,repos=&quot;https://cloud.r-project.org/&quot;)
 library(foreach)}
 func.result &lt;- NULL
  output = list(dimy=&quot;double&quot;,dimx=&quot;double&quot;,dimt=&quot;double&quot;,intercept=&quot;double&quot;,c_p1=&quot;double&quot;,c_p2=&quot;double&quot;,c_p3=&quot;double&quot;,c_p4=&quot;double&quot;,c_p6=&quot;double&quot;,c_p7=&quot;double&quot;,c_p8=&quot;double&quot;,c_p9=&quot;double&quot;,r_sq=&quot;double&quot;,sum_res_sq=&quot;double&quot;)
  tryCatch({ func.result = ddply(.data=df, .variables=c(), .fun=f,affine=affine, crs=crs, extent=extent, tmin=tmin, tmax=tmax, t0=t0, tunit=tunit, tres=tres,.parallel=FALSE) },error = function(err) { df = df[,which(names(df) %in% names(output))]
 var = names(output)[!names(output) %in% names(df)]
 default_values = as.list(rep(0,length(var)))
 names(default_values) = var
 func.result &lt;&lt;- cbind(df,default_values)
 })
 list(dimy=as(func.result$dimy,&quot;double&quot;),dimx=as(func.result$dimx,&quot;double&quot;),dimt=as(func.result$dimt,&quot;double&quot;),intercept=as(func.result$intercept,&quot;double&quot;),c_p1=as(func.result$c_p1,&quot;double&quot;),c_p2=as(func.result$c_p2,&quot;double&quot;),c_p3=as(func.result$c_p3,&quot;double&quot;),c_p4=as(func.result$c_p4,&quot;double&quot;),c_p6=as(func.result$c_p6,&quot;double&quot;),c_p7=as(func.result$c_p7,&quot;double&quot;),c_p8=as(func.result$c_p8,&quot;double&quot;),c_p9=as(func.result$c_p9,&quot;double&quot;),r_sq=as(func.result$r_sq,&quot;double&quot;),sum_res_sq=as(func.result$sum_res_sq,&quot;double&quot;))'),i),__temp_trmm_ethiopia_sub_reparted_2092891414)</code></pre>
<p>Run the function</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sa.array &lt;-<span class="st"> </span><span class="kw">r.apply</span>(<span class="dt">x=</span>trmm.reparted,
                   <span class="dt">f =</span> linearRegressionNeighborhood,
                   <span class="dt">array =</span> <span class="st">&quot;trmm_yearly_linear_model&quot;</span>,
                   <span class="dt">packages =</span> <span class="kw">c</span>(<span class="st">&quot;raster&quot;</span>,<span class="st">&quot;sp&quot;</span>,<span class="st">&quot;rgdal&quot;</span>,<span class="st">&quot;plyr&quot;</span>),
                   <span class="dt">aggregates=</span><span class="kw">c</span>(),
                   <span class="dt">output =</span> <span class="kw">list</span>(<span class="dt">dimy=</span><span class="st">&quot;double&quot;</span>,
                                 <span class="dt">dimx=</span><span class="st">&quot;double&quot;</span>,
                                 <span class="dt">dimt=</span><span class="st">&quot;double&quot;</span>,
                                 <span class="dt">intercept=</span><span class="st">&quot;double&quot;</span>,
                                 <span class="dt">c_p1=</span> <span class="st">&quot;double&quot;</span>,
                                 <span class="dt">c_p2=</span> <span class="st">&quot;double&quot;</span>,
                                 <span class="dt">c_p3=</span> <span class="st">&quot;double&quot;</span>,
                                 <span class="dt">c_p4=</span> <span class="st">&quot;double&quot;</span>,
                                 <span class="dt">c_p6=</span> <span class="st">&quot;double&quot;</span>,
                                 <span class="dt">c_p7=</span> <span class="st">&quot;double&quot;</span>,
                                 <span class="dt">c_p8=</span> <span class="st">&quot;double&quot;</span>,
                                 <span class="dt">c_p9=</span> <span class="st">&quot;double&quot;</span>,
                                 <span class="dt">r_sq =</span> <span class="st">&quot;double&quot;</span>,
                                 <span class="dt">sum_res_sq =</span> <span class="st">&quot;double&quot;</span>)
                   )</code></pre></div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
